{% extends "base.html" %}

{% block title %}Track Help - ReliefBridge{% endblock %}

{% block content %}
<div class="container-fluid my-4">
    <div class="row">
        <!-- Header -->
        <div class="col-12 mb-4">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <h2 class="fw-bold mb-1">
                        <i class="bi bi-radar text-primary me-2"></i>Track Your Help Requests
                    </h2>
                    <p class="text-muted mb-0">Real-time tracking of your active assistance requests</p>
                </div>
                <div>
                    <a href="{{ url_for('create_request') }}" class="btn btn-primary">
                        <i class="bi bi-plus-circle me-2"></i>New Request
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Map View -->
        <div class="col-lg-8 mb-4">
            <div class="card shadow-sm border-0 rounded-4 h-100">
                <div class="card-header bg-white border-0 py-3">
                    <div class="d-flex align-items-center justify-content-between">
                        <h5 class="fw-bold mb-0">
                            <i class="bi bi-map text-primary me-2"></i>Live Tracking Map
                        </h5>
                        <div class="btn-group" role="group">
                            <input type="radio" class="btn-check" name="mapView" id="all" autocomplete="off" checked>
                            <label class="btn btn-outline-primary btn-sm" for="all">All</label>

                            <input type="radio" class="btn-check" name="mapView" id="active" autocomplete="off">
                            <label class="btn btn-outline-primary btn-sm" for="active">Active</label>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="trackingMap" style="height: 500px; border-bottom-left-radius: 1rem; border-bottom-right-radius: 1rem;"></div>
                </div>
            </div>
        </div>

        <!-- Request Status Panel -->
        <div class="col-lg-4">
            <div class="card shadow-sm border-0 rounded-4 h-100">
                <div class="card-header bg-primary text-white py-3 rounded-top-4">
                    <h5 class="fw-bold mb-0">
                        <i class="bi bi-list-check me-2"></i>Request Status
                    </h5>
                </div>
                <div class="card-body p-0" style="max-height: 500px; overflow-y: auto;">
                    {% if active_requests %}
                        {% for req in active_requests %}
                        <div class="request-item p-3 border-bottom" data-request-id="{{ req['$id'] }}">
                            <div class="d-flex align-items-start justify-content-between mb-2">
                                <div class="flex-grow-1">
                                    <h6 class="fw-bold mb-1">
                                        <span class="badge bg-{{ 'info' if req.request_type == 'food' else 'danger' if req.request_type == 'medical' else 'warning' }} me-2">
                                            {{ req.request_type.title() }}
                                        </span>
                                        {% if req.priority == 'high' %}
                                        <span class="badge bg-danger">URGENT</span>
                                        {% endif %}
                                    </h6>
                                    <p class="text-muted small mb-2">{{ req.description[:80] }}...</p>
                                </div>
                                <div class="text-end">
                                    <div class="status-indicator status-{{ req.status }}"></div>
                                </div>
                            </div>

                            <div class="progress mb-2" style="height: 6px;">
                                {% if req.status == 'pending' %}
                                    <div class="progress-bar bg-warning" style="width: 25%"></div>
                                {% elif req.status == 'in_progress' %}
                                    <div class="progress-bar bg-info" style="width: 75%"></div>
                                {% else %}
                                    <div class="progress-bar bg-success" style="width: 100%"></div>
                                {% endif %}
                            </div>

                            <div class="d-flex align-items-center justify-content-between text-muted small">
                                <div>
                                    <i class="bi bi-geo-alt me-1"></i>{{ req.location[:30] }}...
                                </div>
                                <div>
                                    {% if req.volunteer_name %}
                                        <i class="bi bi-person-check text-success me-1"></i>{{ req.volunteer_name }}
                                    {% else %}
                                        <i class="bi bi-clock text-warning me-1"></i>Waiting
                                    {% endif %}
                                </div>
                            </div>

                            {% if req.status == 'in_progress' %}
                            <div class="mt-2">
                                <div class="d-flex align-items-center text-success small">
                                    <div class="spinner-grow spinner-grow-sm me-2" style="width: 0.8rem; height: 0.8rem;"></div>
                                    Help is on the way!
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-5">
                            <i class="bi bi-check-circle text-success display-1 mb-3"></i>
                            <h5 class="fw-bold text-muted">No Active Requests</h5>
                            <p class="text-muted">You have no active help requests at the moment.</p>
                            <a href="{{ url_for('create_request') }}" class="btn btn-primary">
                                Create New Request
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Real-time Statistics -->
    <div class="row mt-4">
        <div class="col-md-3 mb-3">
            <div class="card border-0 bg-primary text-white rounded-4">
                <div class="card-body text-center">
                    <i class="bi bi-clock-history display-4 mb-2 opacity-75"></i>
                    <h3 class="fw-bold" id="totalRequests">{{ active_requests|length }}</h3>
                    <p class="mb-0 opacity-75">Active Requests</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card border-0 bg-success text-white rounded-4">
                <div class="card-body text-center">
                    <i class="bi bi-people-fill display-4 mb-2 opacity-75"></i>
                    <h3 class="fw-bold" id="assignedRequests">
                        {{ active_requests|selectattr('volunteer_name')|list|length }}
                    </h3>
                    <p class="mb-0 opacity-75">Volunteers Assigned</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card border-0 bg-info text-white rounded-4">
                <div class="card-body text-center">
                    <i class="bi bi-geo-alt-fill display-4 mb-2 opacity-75"></i>
                    <h3 class="fw-bold" id="avgDistance">2.3 km</h3>
                    <p class="mb-0 opacity-75">Avg Distance</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card border-0 bg-warning text-white rounded-4">
                <div class="card-body text-center">
                    <i class="bi bi-stopwatch display-4 mb-2 opacity-75"></i>
                    <h3 class="fw-bold" id="avgResponse">12 min</h3>
                    <p class="mb-0 opacity-75">Avg Response</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Initialize tracking map
let trackingMap;
let requestMarkers = [];

document.addEventListener('DOMContentLoaded', function() {
    initializeTrackingMap();
    startRealTimeUpdates();
});

function initializeTrackingMap() {
    // Initialize map
    trackingMap = L.map('trackingMap').setView([40.7128, -74.0060], 12);

    // Add tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(trackingMap);

    // Add request markers
    const requests = {{ active_requests | tojsonfilter | safe }};
    requests.forEach(function(req) {
        addRequestMarker(req);
    });

    // Fit map to show all markers
    if (requestMarkers.length > 0) {
        const group = new L.featureGroup(requestMarkers);
        trackingMap.fitBounds(group.getBounds().pad(0.1));
    }
}

function addRequestMarker(req) {
    const lat = parseFloat(req.latitude);
    const lng = parseFloat(req.longitude);

    if (isNaN(lat) || isNaN(lng)) return;

    // Determine marker color based on status and priority
    let color = '#6c757d'; // default gray
    if (req.status === 'pending') {
        color = req.priority === 'high' ? '#dc3545' : '#ffc107'; // red for urgent, yellow for pending
    } else if (req.status === 'in_progress') {
        color = '#0dcaf0'; // cyan for in progress
    }

    // Create custom marker
    const marker = L.circleMarker([lat, lng], {
        radius: req.priority === 'high' ? 12 : 8,
        fillColor: color,
        color: '#fff',
        weight: 2,
        opacity: 1,
        fillOpacity: 0.8
    }).addTo(trackingMap);

    // Add popup
    const popupContent = `
        <div class="p-2">
            <h6 class="fw-bold mb-2">
                <span class="badge bg-primary">${req.request_type.toUpperCase()}</span>
                ${req.priority === 'high' ? '<span class="badge bg-danger">URGENT</span>' : ''}
            </h6>
            <p class="mb-2 small">${req.description.substring(0, 100)}...</p>
            <div class="text-muted small">
                <div><i class="bi bi-geo-alt me-1"></i>${req.location}</div>
                <div><i class="bi bi-clock me-1"></i>${new Date(req.created_at).toLocaleString()}</div>
                ${req.volunteer_name ? `<div><i class="bi bi-person-check text-success me-1"></i>${req.volunteer_name}</div>` : ''}
            </div>
            <div class="mt-2">
                <span class="badge bg-${req.status === 'pending' ? 'warning' : req.status === 'in_progress' ? 'info' : 'success'}">
                    ${req.status.replace('_', ' ').toUpperCase()}
                </span>
            </div>
        </div>
    `;

    marker.bindPopup(popupContent);
    requestMarkers.push(marker);

    // Add pulsing effect for urgent requests
    if (req.priority === 'high' && req.status === 'pending') {
        marker.addClass = 'pulse-marker';
    }
}

function startRealTimeUpdates() {
    // Update every 30 seconds
    setInterval(function() {
        fetch('/api/requests/live')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateRequestStatus(data.data);
                }
            })
            .catch(error => {
                console.error('Error fetching updates:', error);
            });
    }, 30000);
}

function updateRequestStatus(requests) {
    // Filter user's requests
    const userRequests = requests.filter(req => req.user_id === '{{ session.user_id }}');

    // Update request items in the panel
    userRequests.forEach(function(req) {
        const requestItem = document.querySelector(`[data-request-id="${req.$id}"]`);
        if (requestItem) {
            // Update status indicator
            const statusIndicator = requestItem.querySelector('.status-indicator');
            statusIndicator.className = `status-indicator status-${req.status}`;

            // Update progress bar
            const progressBar = requestItem.querySelector('.progress-bar');
            if (req.status === 'pending') {
                progressBar.style.width = '25%';
                progressBar.className = 'progress-bar bg-warning';
            } else if (req.status === 'in_progress') {
                progressBar.style.width = '75%';
                progressBar.className = 'progress-bar bg-info';
            } else {
                progressBar.style.width = '100%';
                progressBar.className = 'progress-bar bg-success';
            }
        }
    });

    // Update statistics
    const activeCount = userRequests.filter(req => req.status !== 'completed').length;
    const assignedCount = userRequests.filter(req => req.volunteer_name).length;

    document.getElementById('totalRequests').textContent = activeCount;
    document.getElementById('assignedRequests').textContent = assignedCount;
}

// CSS for pulsing markers
const style = document.createElement('style');
style.textContent = `
    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
    }
    .status-pending { background-color: #ffc107; }
    .status-in_progress { background-color: #0dcaf0; animation: pulse 2s infinite; }
    .status-completed { background-color: #198754; }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    .pulse-marker {
        animation: pulse 2s infinite;
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}