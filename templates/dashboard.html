{% extends "base.html" %}
{% block content %}
<div class="container my-5">
    <h1 class="mb-4">Dashboard</h1>
    
    <!-- Stats Cards -->
    <div class="row mb-4">
        {% if session.role == 'victim' %}
            <!-- Victim Stats -->
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <h3>{{ my_requests|length }}</h3>
                        <p>My Requests</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <h3>{{ all_requests|length }}</h3>
                        <p>Total Active</p>
                    </div>
                </div>
            </div>
        {% elif session.role == 'volunteer' %}
            <!-- Volunteer Stats -->
            <div class="col-md-3">
                <div class="card bg-warning text-white">
                    <div class="card-body">
                        <h3>{{ pending_requests|length }}</h3>
                        <p>Available Tasks</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <h3>{{ my_claimed|length }}</h3>
                        <p>My Claimed Tasks</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <h3>{{ all_requests|length }}</h3>
                        <p>Total Active</p>
                    </div>
                </div>
            </div>
        {% else %}
            <!-- Coordinator Stats -->
            <div class="col-md-3">
                <div class="card bg-danger text-white">
                    <div class="card-body">
                        <h3>{{ pending_requests|length }}</h3>
                        <p>Pending</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <h3>{{ claimed_requests|length }}</h3>
                        <p>In Progress</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <h3>{{ all_requests|length }}</h3>
                        <p>Total Requests</p>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
    
    <!-- Action Buttons Based on Role -->
    <div class="mb-4">
        {% if session.role == 'victim' %}
            <a href="{{ url_for('create_request') }}" class="btn btn-danger btn-lg">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>Request Help
            </a>
        {% elif session.role == 'volunteer' %}
            <a href="{{ url_for('available_tasks') }}" class="btn btn-success btn-lg">
                <i class="bi bi-list-check me-2"></i>View Available Tasks
            </a>
        {% endif %}
    </div>
    
    <!-- Different Content Based on Role -->
    {% if session.role == 'victim' %}
        <!-- VICTIM VIEW -->
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5><i class="bi bi-person-fill me-2"></i>My Requests</h5>
            </div>
            <div class="card-body">
                {% if my_requests %}
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Priority</th>
                                <th>Status</th>
                                <th>Volunteer</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for r in my_requests %}
                            <tr>
                                <td><span class="badge bg-secondary">{{ r.request_type|title }}</span></td>
                                <td><span class="badge bg-{{ 'danger' if r.priority == 'high' else 'warning' if r.priority == 'medium' else 'success' }}">{{ r.priority|upper }}</span></td>
                                <td><span class="badge bg-{{ 'warning' if r.status == 'pending' else 'info' if r.status == 'claimed' else 'success' }}">{{ r.status|title }}</span></td>
                                <td>{{ r.volunteer_name or 'Not assigned' }}</td>
                                <td>{{ r.created_at[:10] }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p class="text-center text-muted py-4">You haven't submitted any requests yet</p>
                {% endif %}
            </div>
        </div>
        
    {% elif session.role == 'volunteer' %}
        <!-- VOLUNTEER VIEW -->
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h5><i class="bi bi-clipboard-check me-2"></i>My Claimed Tasks</h5>
            </div>
            <div class="card-body">
                {% if my_claimed %}
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Victim</th>
                                <th>Type</th>
                                <th>Priority</th>
                                <th>Location</th>
                                <th>Phone</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for r in my_claimed %}
                            <tr>
                                <td>{{ r.user_name }}</td>
                                <td><span class="badge bg-secondary">{{ r.request_type|title }}</span></td>
                                <td><span class="badge bg-{{ 'danger' if r.priority == 'high' else 'warning' }}">{{ r.priority|upper }}</span></td>
                                <td>{{ r.location[:40] }}...</td>
                                <td><a href="tel:{{ r.contact_phone }}">{{ r.contact_phone }}</a></td>
                                <td>
                                    <a href="{{ url_for('complete_task', request_id=r['$id']) }}" class="btn btn-sm btn-success">Complete</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p class="text-center text-muted py-4">You haven't claimed any tasks yet</p>
                {% endif %}
            </div>
        </div>
        
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h5><i class="bi bi-exclamation-circle me-2"></i>Available Tasks to Claim</h5>
            </div>
            <div class="card-body">
                {% if pending_requests %}
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Victim</th>
                                <th>Type</th>
                                <th>Priority</th>
                                <th>Location</th>
                                <th>Phone</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for r in pending_requests %}
                            <tr>
                                <td>{{ r.user_name }}</td>
                                <td><span class="badge bg-secondary">{{ r.request_type|title }}</span></td>
                                <td><span class="badge bg-{{ 'danger' if r.priority == 'high' else 'warning' }}">{{ r.priority|upper }}</span></td>
                                <td>{{ r.location[:40] }}...</td>
                                <td><a href="tel:{{ r.contact_phone }}">{{ r.contact_phone }}</a></td>
                                <td>
                                    <a href="{{ url_for('claim_task', request_id=r['$id']) }}" class="btn btn-sm btn-primary">Claim Task</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p class="text-center text-muted py-4">No pending tasks available</p>
                {% endif %}
            </div>
        </div>
        
    {% else %}
        <!-- COORDINATOR VIEW -->
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5><i class="bi bi-speedometer me-2"></i>All Requests Overview</h5>
            </div>
            <div class="card-body">
                {% if all_requests %}
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Victim</th>
                                <th>Type</th>
                                <th>Priority</th>
                                <th>Status</th>
                                <th>Volunteer</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for r in all_requests %}
                            <tr>
                                <td>{{ r.user_name }}</td>
                                <td><span class="badge bg-secondary">{{ r.request_type|title }}</span></td>
                                <td><span class="badge bg-{{ 'danger' if r.priority == 'high' else 'warning' }}">{{ r.priority|upper }}</span></td>
                                <td><span class="badge bg-{{ 'warning' if r.status == 'pending' else 'info' if r.status == 'claimed' else 'success' }}">{{ r.status|title }}</span></td>
                                <td>{{ r.volunteer_name or 'Not assigned' }}</td>
                                <td>{{ r.created_at[:10] }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p class="text-center text-muted py-4">No requests yet</p>
                {% endif %}
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}
