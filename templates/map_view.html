{% extends "base.html" %}

{% block title %}Live Map - ReliefBridge{% endblock %}

{% block content %}
<div class="container-fluid my-4">
    <div class="row mb-4">
        <div class="col-lg-8">
            <h2 class="fw-bold mb-1">
                <i class="bi bi-map-fill text-primary me-2"></i>Live Emergency Response Map
            </h2>
            <p class="text-muted mb-0">Real-time visualization of help requests and volunteer activities</p>
        </div>
        <div class="col-lg-4 text-lg-end">
            <div class="btn-group" role="group">
                <input type="radio" class="btn-check" name="mapFilter" id="allRequests" autocomplete="off" checked>
                <label class="btn btn-outline-primary" for="allRequests">All Requests</label>

                <input type="radio" class="btn-check" name="mapFilter" id="urgentOnly" autocomplete="off">
                <label class="btn btn-outline-danger" for="urgentOnly">Urgent Only</label>

                {% if user_role == 'victim' %}
                <input type="radio" class="btn-check" name="mapFilter" id="myRequests" autocomplete="off">
                <label class="btn btn-outline-success" for="myRequests">My Requests</label>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Map Container -->
        <div class="col-lg-9 mb-4">
            <div class="card shadow-sm border-0 rounded-4">
                <div class="card-header bg-white border-0 py-3">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <div class="bg-primary bg-opacity-10 rounded-circle p-2">
                                    <i class="bi bi-geo-alt-fill text-primary"></i>
                                </div>
                            </div>
                            <div>
                                <h5 class="fw-bold mb-0">Interactive Map</h5>
                                <small class="text-muted">Click markers for details</small>
                            </div>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <div class="live-indicator">
                                <div class="pulse-dot"></div>
                                <small class="text-success fw-semibold">LIVE</small>
                            </div>
                            <button class="btn btn-sm btn-outline-primary" onclick="refreshMap()">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="liveMap" style="height: 500px; border-bottom-left-radius: 1rem; border-bottom-right-radius: 1rem;"></div>
                </div>
            </div>
        </div>

        <!-- Request List Sidebar -->
        <div class="col-lg-3">
            <div class="card shadow-sm border-0 rounded-4 h-100">
                <div class="card-header bg-info text-white py-3 rounded-top-4">
                    <h6 class="fw-bold mb-0">
                        <i class="bi bi-list-ul me-2"></i>Active Requests
                    </h6>
                </div>
                <div class="card-body p-0" style="max-height: 500px; overflow-y: auto;" id="requestsList">
                    {% if requests %}
                        {% for req in requests %}
                        <div class="request-item p-3 border-bottom" data-lat="{{ req.latitude }}" data-lng="{{ req.longitude }}" 
                             data-id="{{ req['$id'] }}" data-priority="{{ req.priority }}" data-status="{{ req.status }}"
                             data-user-id="{{ req.user_id }}">
                            <div class="d-flex align-items-start justify-content-between mb-2">
                                <div class="flex-grow-1">
                                    <div class="d-flex align-items-center mb-1">
                                        <span class="badge bg-{{ 'info' if req.request_type == 'food' else 'danger' if req.request_type == 'medical' else 'warning' if req.request_type == 'shelter' else 'success' }} me-2">
                                            {{ req.request_type.title() }}
                                        </span>
                                        {% if req.priority == 'high' %}
                                        <span class="badge bg-danger">URGENT</span>
                                        {% endif %}
                                    </div>
                                    <h6 class="fw-semibold mb-1">{{ req.user_name }}</h6>
                                    <p class="text-muted small mb-0">{{ req.description[:60] }}...</p>
                                </div>
                                <button class="btn btn-sm btn-outline-primary" onclick="focusMarker('{{ req['$id'] }}')">
                                    <i class="bi bi-geo-alt"></i>
                                </button>
                            </div>

                            <div class="d-flex align-items-center justify-content-between">
                                <small class="text-muted">
                                    <i class="bi bi-clock me-1"></i>{{ req.created_at[:10] }}
                                </small>
                                <div>
                                    {% if req.status == 'pending' %}
                                        <span class="badge bg-warning">Pending</span>
                                    {% elif req.status == 'in_progress' %}
                                        <span class="badge bg-info">In Progress</span>
                                    {% else %}
                                        <span class="badge bg-success">Completed</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-5">
                            <i class="bi bi-map text-muted display-1"></i>
                            <p class="text-muted mt-3">No requests to display</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Map Legend -->
    <div class="row mt-3">
        <div class="col-12">
            <div class="card border-0 bg-light rounded-4">
                <div class="card-body py-3">
                    <div class="d-flex flex-wrap align-items-center justify-content-center gap-4">
                        <div class="legend-item">
                            <div class="legend-marker bg-danger"></div>
                            <small class="fw-semibold">Urgent</small>
                        </div>
                        <div class="legend-item">
                            <div class="legend-marker bg-warning"></div>
                            <small class="fw-semibold">Medium Priority</small>
                        </div>
                        <div class="legend-item">
                            <div class="legend-marker bg-secondary"></div>
                            <small class="fw-semibold">Low Priority</small>
                        </div>
                        <div class="legend-item">
                            <div class="legend-marker bg-info"></div>
                            <small class="fw-semibold">In Progress</small>
                        </div>
                        <div class="legend-item">
                            <div class="legend-marker bg-success"></div>
                            <small class="fw-semibold">Completed</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let liveMap;
let markers = {};
let currentUserRole = '{{ user_role }}';
let currentUserId = '{{ session.user_id }}';

document.addEventListener('DOMContentLoaded', function() {
    initializeLiveMap();
    setupMapFilters();
    startLiveUpdates();
});

function initializeLiveMap() {
    // Initialize map
    liveMap = L.map('liveMap').setView([40.7128, -74.0060], 11);

    // Add tile layer with custom style
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(liveMap);

    // Add markers for all requests
    const requests = {{ requests | tojsonfilter | safe }};
    requests.forEach(function(req) {
        addRequestMarker(req);
    });

    // Fit map to show all markers
    if (Object.keys(markers).length > 0) {
        const group = new L.featureGroup(Object.values(markers));
        liveMap.fitBounds(group.getBounds().pad(0.1));
    }
}

function addRequestMarker(req) {
    const lat = parseFloat(req.latitude);
    const lng = parseFloat(req.longitude);

    if (isNaN(lat) || isNaN(lng)) return;

    // Determine marker style based on status and priority
    let color, size, pulseClass = '';

    if (req.status === 'completed') {
        color = '#198754'; // success green
        size = 8;
    } else if (req.status === 'in_progress') {
        color = '#0dcaf0'; // info cyan
        size = 10;
        pulseClass = 'pulse-marker';
    } else { // pending
        if (req.priority === 'high') {
            color = '#dc3545'; // danger red
            size = 14;
            pulseClass = 'urgent-pulse';
        } else if (req.priority === 'medium') {
            color = '#ffc107'; // warning yellow
            size = 10;
        } else {
            color = '#6c757d'; // secondary gray
            size = 8;
        }
    }

    // Create custom marker
    const marker = L.circleMarker([lat, lng], {
        radius: size,
        fillColor: color,
        color: '#fff',
        weight: 2,
        opacity: 1,
        fillOpacity: 0.8,
        className: pulseClass
    }).addTo(liveMap);

    // Create detailed popup
    const popupContent = createPopupContent(req);
    marker.bindPopup(popupContent, {
        maxWidth: 300,
        className: 'custom-popup'
    });

    markers[req.$id] = marker;
}

function createPopupContent(req) {
    const urgentBadge = req.priority === 'high' ? '<span class="badge bg-danger ms-2">URGENT</span>' : '';
    const statusColor = req.status === 'pending' ? 'warning' : req.status === 'in_progress' ? 'info' : 'success';

    return `
        <div class="popup-content">
            <div class="d-flex align-items-center justify-content-between mb-2">
                <h6 class="fw-bold mb-0">
                    <span class="badge bg-primary">${req.request_type.toUpperCase()}</span>
                    ${urgentBadge}
                </h6>
                <span class="badge bg-${statusColor}">${req.status.replace('_', ' ').toUpperCase()}</span>
            </div>

            <div class="mb-2">
                <strong>${req.user_name}</strong>
                <p class="text-muted small mb-1">${req.description.substring(0, 120)}...</p>
            </div>

            <div class="mb-2">
                <div class="d-flex align-items-center mb-1">
                    <i class="bi bi-geo-alt text-primary me-2"></i>
                    <small>${req.location}</small>
                </div>
                <div class="d-flex align-items-center mb-1">
                    <i class="bi bi-telephone text-success me-2"></i>
                    <small>${req.contact_phone}</small>
                </div>
                <div class="d-flex align-items-center">
                    <i class="bi bi-clock text-muted me-2"></i>
                    <small>${new Date(req.created_at).toLocaleString()}</small>
                </div>
            </div>

            ${req.volunteer_name ? `
                <div class="border-top pt-2">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-person-check text-success me-2"></i>
                        <small><strong>Volunteer:</strong> ${req.volunteer_name}</small>
                    </div>
                </div>
            ` : ''}
        </div>
    `;
}

function setupMapFilters() {
    const filterButtons = document.querySelectorAll('input[name="mapFilter"]');

    filterButtons.forEach(button => {
        button.addEventListener('change', function() {
            filterRequests(this.id);
        });
    });
}

function filterRequests(filter) {
    const requestItems = document.querySelectorAll('.request-item');

    // Clear existing markers
    Object.values(markers).forEach(marker => {
        liveMap.removeLayer(marker);
    });
    markers = {};

    // Filter and display
    requestItems.forEach(item => {
        const priority = item.dataset.priority;
        const userId = item.dataset.userId;
        const status = item.dataset.status;

        let shouldShow = false;

        if (filter === 'allRequests') {
            shouldShow = true;
        } else if (filter === 'urgentOnly') {
            shouldShow = priority === 'high';
        } else if (filter === 'myRequests' && currentUserRole === 'victim') {
            shouldShow = userId === currentUserId;
        }

        if (shouldShow) {
            item.style.display = '';
            // Re-add marker
            const req = {
                $id: item.dataset.id,
                latitude: item.dataset.lat,
                longitude: item.dataset.lng,
                priority: priority,
                status: status,
                // Get other data from the item
                request_type: item.querySelector('.badge').textContent.toLowerCase(),
                user_name: item.querySelector('h6').textContent,
                description: item.querySelector('p').textContent,
                location: item.querySelector('.text-muted').textContent.split('â¢')[0].trim(),
                contact_phone: 'Contact via app',
                created_at: new Date().toISOString(),
                volunteer_name: status === 'in_progress' ? 'Assigned' : null
            };
            addRequestMarker(req);
        } else {
            item.style.display = 'none';
        }
    });

    // Refit map bounds
    if (Object.keys(markers).length > 0) {
        const group = new L.featureGroup(Object.values(markers));
        liveMap.fitBounds(group.getBounds().pad(0.1));
    }
}

function focusMarker(requestId) {
    const marker = markers[requestId];
    if (marker) {
        liveMap.setView(marker.getLatLng(), 15);
        marker.openPopup();
    }
}

function refreshMap() {
    // In a real app, this would fetch new data
    location.reload();
}

function startLiveUpdates() {
    // Update every 30 seconds
    setInterval(function() {
        // In a real app, this would fetch updates via API
        console.log('Checking for map updates...');
    }, 30000);
}

// Custom styles for markers and popups
const style = document.createElement('style');
style.textContent = `
    .pulse-marker {
        animation: pulse 2s infinite;
    }

    .urgent-pulse {
        animation: urgentPulse 1s infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }

    @keyframes urgentPulse {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.8; transform: scale(1.1); }
    }

    .live-indicator {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .pulse-dot {
        width: 8px;
        height: 8px;
        background-color: #198754;
        border-radius: 50%;
        animation: pulse 2s infinite;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .legend-marker {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 0 3px rgba(0,0,0,0.3);
    }

    .custom-popup .leaflet-popup-content {
        margin: 12px 16px;
    }

    .popup-content {
        min-width: 250px;
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}