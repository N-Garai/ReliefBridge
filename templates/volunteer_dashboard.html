{% extends "base.html" %}

{% block title %}Volunteer Dashboard - ReliefBridge{% endblock %}

{% block content %}
<div class="container-fluid my-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="d-flex align-items-center mb-3">
                <div class="me-3">
                    <div class="bg-success bg-opacity-10 rounded-circle p-3">
                        <i class="bi bi-people-fill text-success fs-2"></i>
                    </div>
                </div>
                <div>
                    <h2 class="fw-bold mb-1">Welcome, {{ session.user_name }}</h2>
                    <p class="text-muted mb-0">Find and assist people in need in your community</p>
                </div>
            </div>
        </div>
        <div class="col-lg-4 text-lg-end">
            <div class="volunteer-badge bg-success bg-opacity-10 text-success px-3 py-2 rounded-pill">
                <i class="bi bi-shield-check me-2"></i>Verified Volunteer
            </div>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card border-0 bg-gradient-primary text-white rounded-4">
                <div class="card-body text-center">
                    <i class="bi bi-search display-4 mb-2 opacity-75"></i>
                    <h3 class="fw-bold">{{ available_requests|length }}</h3>
                    <p class="mb-0 opacity-75">Available Requests</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card border-0 bg-gradient-success text-white rounded-4">
                <div class="card-body text-center">
                    <i class="bi bi-hand-thumbs-up display-4 mb-2 opacity-75"></i>
                    <h3 class="fw-bold">{{ my_requests|length }}</h3>
                    <p class="mb-0 opacity-75">My Assignments</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card border-0 bg-gradient-info text-white rounded-4">
                <div class="card-body text-center">
                    <i class="bi bi-check-circle display-4 mb-2 opacity-75"></i>
                    <h3 class="fw-bold">{{ my_requests|selectattr('status', 'equalto', 'completed')|list|length }}</h3>
                    <p class="mb-0 opacity-75">Completed</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card border-0 bg-gradient-warning text-white rounded-4">
                <div class="card-body text-center">
                    <i class="bi bi-star display-4 mb-2 opacity-75"></i>
                    <h3 class="fw-bold">4.9</h3>
                    <p class="mb-0 opacity-75">Rating</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Available Requests -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm border-0 rounded-4 h-100">
                <div class="card-header bg-primary text-white py-3 rounded-top-4">
                    <div class="d-flex align-items-center justify-content-between">
                        <h5 class="fw-bold mb-0">
                            <i class="bi bi-search me-2"></i>Available Help Requests
                        </h5>
                        <span class="badge bg-white text-primary">{{ available_requests|length }}</span>
                    </div>
                </div>
                <div class="card-body p-0" style="max-height: 600px; overflow-y: auto;">
                    {% if available_requests %}
                        {% for req in available_requests %}
                        <div class="request-card p-3 border-bottom position-relative {{ 'urgent-request' if req.priority == 'high' else '' }}">
                            {% if req.priority == 'high' %}
                            <div class="urgent-indicator">
                                <i class="bi bi-exclamation-triangle-fill text-danger"></i>
                            </div>
                            {% endif %}

                            <div class="d-flex align-items-start justify-content-between mb-3">
                                <div class="flex-grow-1">
                                    <div class="d-flex align-items-center mb-2">
                                        <span class="badge bg-{{ 'info' if req.request_type == 'food' else 'danger' if req.request_type == 'medical' else 'warning' if req.request_type == 'shelter' else 'success' }} me-2">
                                            <i class="bi bi-{{ 'egg-fried' if req.request_type == 'food' else 'heart-pulse' if req.request_type == 'medical' else 'house' if req.request_type == 'shelter' else 'truck' }} me-1"></i>
                                            {{ req.request_type.title() }}
                                        </span>
                                        {% if req.priority == 'high' %}
                                        <span class="badge bg-danger animate-pulse">URGENT</span>
                                        {% endif %}
                                    </div>
                                    <h6 class="fw-bold mb-2">{{ req.user_name }}</h6>
                                    <p class="text-muted mb-2 small">{{ req.description[:120] }}...</p>
                                </div>
                            </div>

                            <div class="mb-3">
                                <div class="row text-muted small">
                                    <div class="col-6">
                                        <i class="bi bi-geo-alt text-primary me-1"></i>
                                        {{ req.location[:25] }}{% if req.location|length > 25 %}...{% endif %}
                                    </div>
                                    <div class="col-6">
                                        <i class="bi bi-telephone text-success me-1"></i>
                                        {{ req.contact_phone }}
                                    </div>
                                </div>
                                <div class="mt-1 text-muted small">
                                    <i class="bi bi-clock me-1"></i>
                                    Posted {{ (req.created_at | regex_replace(r'T.*', '')) }}
                                </div>
                            </div>

                            <div class="d-flex align-items-center justify-content-between">
                                <small class="text-muted">
                                    <i class="bi bi-geo me-1"></i>~2.3 km away
                                </small>
                                <form method="POST" action="{{ url_for('claim_request', request_id=req['$id']) }}" class="d-inline">
                                    <button type="submit" class="btn btn-primary btn-sm px-3" onclick="return confirm('Are you sure you want to claim this request?')">
                                        <i class="bi bi-hand-thumbs-up me-1"></i>Claim
                                    </button>
                                </form>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-5">
                            <i class="bi bi-check-circle text-success display-1 mb-3"></i>
                            <h5 class="fw-bold text-muted">No Available Requests</h5>
                            <p class="text-muted">All current requests have been claimed. Check back later!</p>
                            <button class="btn btn-outline-primary" onclick="location.reload()">
                                <i class="bi bi-arrow-clockwise me-2"></i>Refresh
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- My Claimed Requests -->
        <div class="col-lg-6">
            <div class="card shadow-sm border-0 rounded-4 h-100">
                <div class="card-header bg-success text-white py-3 rounded-top-4">
                    <div class="d-flex align-items-center justify-content-between">
                        <h5 class="fw-bold mb-0">
                            <i class="bi bi-list-check me-2"></i>My Assignments
                        </h5>
                        <span class="badge bg-white text-success">{{ my_requests|length }}</span>
                    </div>
                </div>
                <div class="card-body p-0" style="max-height: 600px; overflow-y: auto;">
                    {% if my_requests %}
                        {% for req in my_requests %}
                        <div class="request-card p-3 border-bottom">
                            <div class="d-flex align-items-start justify-content-between mb-3">
                                <div class="flex-grow-1">
                                    <div class="d-flex align-items-center mb-2">
                                        <span class="badge bg-{{ 'info' if req.request_type == 'food' else 'danger' if req.request_type == 'medical' else 'warning' if req.request_type == 'shelter' else 'success' }} me-2">
                                            {{ req.request_type.title() }}
                                        </span>
                                        {% if req.status == 'in_progress' %}
                                            <span class="badge bg-warning">
                                                <i class="bi bi-arrow-right me-1"></i>In Progress
                                            </span>
                                        {% else %}
                                            <span class="badge bg-success">
                                                <i class="bi bi-check-circle-fill me-1"></i>Completed
                                            </span>
                                        {% endif %}
                                    </div>
                                    <h6 class="fw-bold mb-2">{{ req.user_name }}</h6>
                                    <p class="text-muted mb-2 small">{{ req.description[:100] }}...</p>
                                </div>
                            </div>

                            <div class="mb-3">
                                <div class="row text-muted small">
                                    <div class="col-6">
                                        <i class="bi bi-geo-alt text-primary me-1"></i>{{ req.location[:20] }}...
                                    </div>
                                    <div class="col-6">
                                        <i class="bi bi-telephone text-success me-1"></i>{{ req.contact_phone }}
                                    </div>
                                </div>
                                {% if req.claimed_at %}
                                <div class="mt-1 text-muted small">
                                    <i class="bi bi-clock me-1"></i>Claimed {{ req.claimed_at[:10] }}
                                </div>
                                {% endif %}
                            </div>

                            {% if req.status == 'in_progress' %}
                            <div class="d-flex gap-2">
                                <form method="POST" action="{{ url_for('complete_request', request_id=req['$id']) }}" class="flex-grow-1">
                                    <button type="submit" class="btn btn-success btn-sm w-100" onclick="return confirm('Mark this request as completed?')">
                                        <i class="bi bi-check-circle me-1"></i>Mark Complete
                                    </button>
                                </form>
                                <a href="tel:{{ req.contact_phone }}" class="btn btn-outline-primary btn-sm">
                                    <i class="bi bi-telephone"></i>
                                </a>
                            </div>
                            {% else %}
                            <div class="d-flex align-items-center text-success">
                                <i class="bi bi-check-circle-fill me-2"></i>
                                <small>Completed successfully</small>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-5">
                            <i class="bi bi-clipboard text-muted display-1 mb-3"></i>
                            <h5 class="fw-bold text-muted">No Assignments Yet</h5>
                            <p class="text-muted">Claim requests from the available list to start helping!</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Auto-refresh every 60 seconds
setInterval(function() {
    location.reload();
}, 60000);

// Add visual feedback for claim buttons
document.querySelectorAll('form[action*="claim"]').forEach(form => {
    form.addEventListener('submit', function() {
        const button = this.querySelector('button');
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="bi bi-spinner spinner-border spinner-border-sm me-1"></i>Claiming...';
        button.disabled = true;

        // Re-enable after 3 seconds if still on page
        setTimeout(() => {
            button.innerHTML = originalText;
            button.disabled = false;
        }, 3000);
    });
});
</script>

<style>
.urgent-request {
    border-left: 4px solid #dc3545 !important;
    background: linear-gradient(90deg, rgba(220,53,69,0.05) 0%, rgba(255,255,255,1) 5%);
}

.urgent-indicator {
    position: absolute;
    top: 10px;
    right: 10px;
    animation: pulse 2s infinite;
}

.animate-pulse {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.request-card {
    transition: all 0.3s ease;
}

.request-card:hover {
    background-color: #f8f9fa;
    transform: translateX(2px);
}

.volunteer-badge {
    border: 2px solid rgba(25,135,84,0.2);
}
</style>
{% endblock %}